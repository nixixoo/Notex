<div class="chat-sidebar-container">
  <!-- Toggle Button -->
  <button class="chat-toggle" (click)="toggle()" [class.open]="isOpen">
    <div class="icon-container">
      <mat-icon class="chat-icon" [class.hidden]="isOpen">chat</mat-icon>
      <mat-icon class="close-icon" [class.hidden]="!isOpen">close</mat-icon>
    </div>
    <span class="toggle-label" *ngIf="!isOpen">AI</span>
  </button>

  <!-- Chat Content -->
  <div class="chat-sidebar-content" *ngIf="isOpen" [@slideInOut]>
    <div class="chat-header">
      <h2>AI Assistant</h2>
      <button mat-icon-button (click)="clearChat()" aria-label="Clear chat">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    
    <div class="messages-container" #messagesContainer>
      <!-- Loading messages indicator -->
      <div *ngIf="messagesLoading" class="loading-messages">
        <mat-spinner diameter="30"></mat-spinner>
        <p>Loading chat history...</p>
      </div>
      
      <!-- Empty chat message -->
      <div *ngIf="!messagesLoading && messages.length === 0" class="empty-chat">
        <p>Ask me about your note</p>
      </div>
      
      <!-- Chat messages -->
      <div class="messages-list" [@simpleFade]="fadeState">
        <div *ngFor="let msg of messages" class="message" 
             [ngClass]="{'user-message': msg.isUser, 'ai-message': !msg.isUser, 'new-message': isNewMessage(msg), 'sending-message': msg.isTemporary}"
             [@newMessageFade]="isNewMessage(msg) ? 'in' : 'none'">
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">{{ msg.isUser ? 'You' : 'AI Assistant' }}</span>
              <span class="message-time">{{ msg.timestamp | date:'short' }}</span>
            </div>
            <div class="message-text" [innerHTML]="renderMarkdown(msg.content)"></div>
          </div>
        </div>
      </div>
      
      <!-- AI thinking indicator -->
      <div *ngIf="isLoading" class="loading-message">
        <mat-spinner diameter="20"></mat-spinner>
        <span>AI is thinking...</span>
      </div>
    </div>
    
    <div class="chat-input">
      <mat-form-field appearance="outline" class="full-width">
        <textarea 
          matInput 
          [(ngModel)]="message" 
          placeholder="Ask about your note..." 
          (keydown.enter)="handleEnterKey($event)"
          (input)="autoGrow($event.target)"
          #messageInput
          rows="2"
          class="chat-textarea"
        ></textarea>
        <button 
          mat-icon-button 
          matSuffix 
          (click)="sendMessage()" 
          [disabled]="!message.trim() || isLoading"
          aria-label="Send message"
        >
          <mat-icon>send</mat-icon>
        </button>
      </mat-form-field>
    </div>
  </div>
</div>
