<div class="page-layout">
  <app-sidebar 
    [activeCount]="activeCount"
    [archivedCount]="archivedCount"
    [trashedCount]="trashedCount"
    [groupCount]="groupCount">
  </app-sidebar>
  
  <div class="main-content">
    <div *ngIf="authService.isGuestMode()" class="guest-banner">
      <span>You're using guest mode. Groups will be saved locally.</span>
      <button (click)="convertToPermanentAccount()" class="guest-btn">
        Create Permanent Account
      </button>
    </div>

    <div class="groups-container">
      <div class="groups-header">
        <h1 class="groups-title">My Groups</h1>
      </div>
      
      <div *ngIf="showNewGroupForm" 
           class="new-group-form-container"
           [@slideDown]>
        <form [formGroup]="newGroupForm" (ngSubmit)="createGroup()" class="new-group-form">
          <div class="form-group">
            <label for="name">Group Name</label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="name" 
                formControlName="name" 
                class="form-control"
                [class.is-invalid]="name?.invalid && (name?.dirty || name?.touched)"
                [maxlength]="NAME_MAX_LENGTH"
              >
            </div>
            <div class="feedback-container">
              <div class="feedback-left">
                <div *ngIf="name?.invalid && (name?.dirty || name?.touched)" class="error-message">
                  <span *ngIf="name?.errors?.['required']">Group name is required</span>
                  <span *ngIf="name?.errors?.['maxlength']">Group name cannot exceed 50 characters</span>
                </div>
              </div>
              <span class="character-counter" 
                    [class.warning]="nameLengthWarning"
                    [class.danger]="nameLengthDanger">
                {{ name?.value?.length || 0 }}/{{ NAME_MAX_LENGTH }}
              </span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="description">Description</label>
            <div class="input-wrapper">
              <textarea 
                id="description" 
                formControlName="description" 
                class="form-control"
                [class.is-invalid]="description?.invalid && (description?.dirty || description?.touched)"
                [maxlength]="DESCRIPTION_MAX_LENGTH"
                rows="3"
              ></textarea>
            </div>
            <div class="feedback-container">
              <div class="feedback-left">
                <div *ngIf="description?.invalid && (description?.dirty || description?.touched)" class="error-message">
                  <span *ngIf="description?.errors?.['required']">Group description is required</span>
                  <span *ngIf="description?.errors?.['maxlength']">Group description cannot exceed 150 characters</span>
                </div>
              </div>
              <span class="character-counter" 
                    [class.warning]="descriptionLengthWarning"
                    [class.danger]="descriptionLengthDanger">
                {{ description?.value?.length || 0 }}/{{ DESCRIPTION_MAX_LENGTH }}
              </span>
            </div>
          </div>
          
          <!-- Color picker -->
          <div class="form-group color-picker-container">
            <label>Group Color:</label>
            <div class="color-options">
              <div 
                *ngFor="let colorOption of colorOptions" 
                class="color-option" 
                [style.background-color]="colorOption.value"
                [class.selected]="selectedColor === colorOption.value"
                [class.no-color]="colorOption.name === 'none'"
                (click)="setGroupColor(colorOption.value)"
                [attr.title]="colorOption.name">
                <mat-icon *ngIf="selectedColor === colorOption.value">check</mat-icon>
              </div>
            </div>
          </div>
          
          <button type="submit" class="submit-btn" [disabled]="newGroupForm.invalid || isLoading">
            {{ isLoading ? 'Creating...' : 'Create Group' }}
          </button>
        </form>
      </div>
      
      <div *ngIf="isLoading" class="loading-container" [@fadeIn]>
        <div class="loading-spinner"></div>
        <p>Loading groups...</p>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="!isLoading && groups.length === 0" class="groups-grid">
        <!-- New Group Card -->
        <div *ngIf="showEmptyMessage" class="group-card add-group-card centered-empty"
             (click)="toggleNewGroupForm()"
             [@fadeIn]>
          <div class="add-group-content">
            <mat-icon class="add-group-icon">create_new_folder</mat-icon>
            <span class="add-text">New Group</span>
          </div>
        </div>
      </div>
      
      <!-- Groups grid -->
      <div *ngIf="!isLoading && groups.length > 0" 
           class="groups-grid" 
           [@listAnimation]="groups.length">
        
        <!-- New Group Card -->
        <div class="group-card add-group-card"
             (click)="toggleNewGroupForm()"
             [@fadeIn]>
          <div class="add-group-content">
            <mat-icon class="add-group-icon">create_new_folder</mat-icon>
            <span class="add-text">New Group</span>
          </div>
        </div>
        
        <!-- Existing Groups -->
        <div *ngFor="let group of groups; trackBy: trackGroupById" class="group-card">
          <div class="group-card-tab" [style.background-color]="group.color || 'white'"></div>
          <div class="group-card-content" [routerLink]="['/groups', group.id]">
            <div class="group-text-wrapper">
              <h2 class="group-name">{{ group.name }}</h2>
              <p class="group-description">{{ group.description }}</p>
            </div>
            <div class="group-footer">
              <span class="group-date">{{ group.updatedAt | date:'medium' }}</span>
            </div>
          </div>
          <div class="group-menu" (click)="stopPropagation($event)">
            <app-group-menu 
              [group]="group"
              (delete)="deleteGroup($event)">
            </app-group-menu>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
