<div class="page-layout">
  <app-sidebar 
    [activeCount]="activeCount"
    [archivedCount]="archivedCount"
    [trashedCount]="trashedCount"
    [groupCount]="groupCount">
  </app-sidebar>

  <!-- Add Chat Sidebar Component -->
  <app-chat-sidebar *ngIf="note" [noteContent]="noteForm.get('content')?.value || ''"></app-chat-sidebar>

  <div class="editor-container">
    <div *ngIf="authService.isGuestMode()" class="guest-banner">
      <span>You're using guest mode. Notes will be saved locally.</span>
      <button (click)="convertToPermanentAccount()" class="guest-btn">
        Create Permanent Account
      </button>
    </div>

    <div class="editor-header">
      <button class="back-btn" (click)="location.back()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="editor-actions">
        <button *ngIf="isEditable" class="save-btn" (click)="saveNote()" [disabled]="noteForm.invalid || isSaving">
          {{ isSaving ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading note...</p>
    </div>

    <div *ngIf="!isLoading && !note" class="note-not-found">
      <p>Note not found</p>
      <button class="back-btn" (click)="location.back()">Go Back</button>
    </div>

    <div *ngIf="!isLoading && note && !isEditable" class="readonly-notice">
      <mat-icon>info</mat-icon>
      <span>This note is {{ note.status === 'archived' ? 'archived' : 'in trash' }} and cannot be edited. Restore it to make changes.</span>
    </div>

    <form *ngIf="!isLoading && note" [formGroup]="noteForm" class="note-form" [@fadeIn]>
      <div class="form-group">
        <div class="input-wrapper">
          <input
            type="text"
            formControlName="title"
            class="title-input"
            [class.is-invalid]="title?.invalid && (title?.dirty || title?.touched)"
            placeholder="Note Title"
            [maxlength]="TITLE_MAX_LENGTH"
          >
        </div>
        <div class="feedback-container">
          <div class="feedback-left">
            <div *ngIf="title?.invalid && (title?.dirty || title?.touched)" class="error-message">
              <span *ngIf="title?.errors?.['required']">Title is required</span>
              <span *ngIf="title?.errors?.['maxlength']">Title cannot exceed 75 characters</span>
            </div>
          </div>
          <span class="character-counter" 
                [class.warning]="titleLengthWarning"
                [class.danger]="titleLengthDanger">
            {{ title?.value?.length || 0 }}/{{ TITLE_MAX_LENGTH }}
          </span>
        </div>
      </div>

      <div class="form-group">
        <div class="input-wrapper">
          <input
            type="text"
            formControlName="subtitle"
            class="subtitle-input"
            [class.is-invalid]="subtitle?.invalid && (subtitle?.dirty || subtitle?.touched)"
            placeholder="Note Subtitle"
            [maxlength]="SUBTITLE_MAX_LENGTH"
          >
        </div>
        <div class="feedback-container">
          <div class="feedback-left">
            <div *ngIf="subtitle?.invalid && (subtitle?.dirty || subtitle?.touched)" class="error-message">
              <span *ngIf="subtitle?.errors?.['required']">Subtitle is required</span>
              <span *ngIf="subtitle?.errors?.['maxlength']">Subtitle cannot exceed 150 characters</span>
            </div>
          </div>
          <span class="character-counter" 
                [class.warning]="subtitleLengthWarning"
                [class.danger]="subtitleLengthDanger">
            {{ subtitle?.value?.length || 0 }}/{{ SUBTITLE_MAX_LENGTH }}
          </span>
        </div>
      </div>

      <!-- Color picker -->
      <div class="form-group color-picker-container" *ngIf="isEditable">
        <label class="color-picker-label">Note Color:</label>
        <div class="color-options">
          <div 
            *ngFor="let colorOption of colorOptions" 
            class="color-option" 
            [style.background-color]="colorOption.value"
            [class.selected]="color?.value === colorOption.value"
            [class.no-color]="colorOption.name === 'none'"
            (click)="setNoteColor(colorOption.value)"
            [attr.title]="colorOption.name">
            <mat-icon *ngIf="color?.value === colorOption.value">check</mat-icon>
          </div>
        </div>
      </div>

      <div class="form-group">
        <textarea
          formControlName="content"
          class="content-input"
          [class.is-invalid]="noteForm.get('content')?.invalid && (noteForm.get('content')?.dirty || noteForm.get('content')?.touched)"
          placeholder="Write your note here..."
        ></textarea>
        <div class="feedback-container">
          <div *ngIf="noteForm.get('content')?.invalid && (noteForm.get('content')?.dirty || noteForm.get('content')?.touched)" class="error-message">
            <span *ngIf="noteForm.get('content')?.errors?.['required']">Content is required</span>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>