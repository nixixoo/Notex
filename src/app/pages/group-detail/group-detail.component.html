<div class="page-layout">
  <app-sidebar 
    [activeCount]="activeCount"
    [archivedCount]="archivedCount"
    [trashedCount]="trashedCount"
    [groupCount]="groupCount">
  </app-sidebar>
  
  <div class="main-content">
    <div *ngIf="authService.isGuestMode()" class="guest-banner">
      <span>You're using guest mode. Notes will be saved locally.</span>
      <button (click)="convertToPermanentAccount()" class="guest-btn">
        Create Permanent Account
      </button>
    </div>

    <div class="notes-container">
      <!-- Loading Spinner for Group -->
      <div *ngIf="isLoadingGroup" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading group...</p>
      </div>

      <!-- Group Header -->
      <div *ngIf="!isLoadingGroup && group" class="group-header" [@fadeInOut]>
        <div class="header-left">
          <button class="back-button" routerLink="/groups">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <h1 class="group-title" [title]="group?.name">{{ group?.name || '' }}</h1>
        </div>
        <div class="header-controls">
          <label class="switch">
            <input type="checkbox" [(ngModel)]="showPreview">
            <span class="slider round"></span>
          </label>
          <span class="preview-label">Show Preview</span>
          <button class="edit-group-btn" (click)="toggleEditGroupForm()">
            <mat-icon>edit</mat-icon>
            Edit Group
          </button>
        </div>
      </div>

      <!-- Edit Group Form -->
      <div *ngIf="showEditGroupForm" class="new-group-form-container" [@slideDown]>
        <form [formGroup]="editGroupForm" (ngSubmit)="updateGroup()" class="new-group-form">
          <div class="form-group">
            <label for="name">Group Name</label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="name" 
                formControlName="name" 
                class="form-control"
                [class.is-invalid]="name?.invalid && (name?.dirty || name?.touched)"
                [maxlength]="NAME_MAX_LENGTH"
              >
            </div>
            <div class="feedback-container">
              <div class="feedback-left">
                <div *ngIf="name?.invalid && (name?.dirty || name?.touched)" class="error-message">
                  <span *ngIf="name?.errors?.['required']">Group name is required</span>
                  <span *ngIf="name?.errors?.['maxlength']">Group name cannot exceed 50 characters</span>
                </div>
              </div>
              <span class="character-counter" 
                    [class.warning]="nameLengthWarning"
                    [class.danger]="nameLengthDanger">
                {{ name?.value?.length || 0 }}/{{ NAME_MAX_LENGTH }}
              </span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="description">Description</label>
            <div class="input-wrapper">
              <textarea 
                id="description" 
                formControlName="description" 
                class="form-control"
                [class.is-invalid]="description?.invalid && (description?.dirty || description?.touched)"
                [maxlength]="DESCRIPTION_MAX_LENGTH"
                rows="3"
              ></textarea>
            </div>
            <div class="feedback-container">
              <div class="feedback-left">
                <div *ngIf="description?.invalid && (description?.dirty || description?.touched)" class="error-message">
                  <span *ngIf="description?.errors?.['required']">Group description is required</span>
                  <span *ngIf="description?.errors?.['maxlength']">Group description cannot exceed 150 characters</span>
                </div>
              </div>
              <span class="character-counter" 
                    [class.warning]="descriptionLengthWarning"
                    [class.danger]="descriptionLengthDanger">
                {{ description?.value?.length || 0 }}/{{ DESCRIPTION_MAX_LENGTH }}
              </span>
            </div>
          </div>
          
          <!-- Color picker for group -->
          <div class="form-group color-picker-container">
            <label>Group Color:</label>
            <div class="color-options">
              <div 
                *ngFor="let colorOption of colorOptions" 
                class="color-option" 
                [style.background-color]="colorOption.value"
                [class.selected]="selectedColor === colorOption.value"
                [class.no-color]="colorOption.name === 'none'"
                (click)="setNoteColor(colorOption.value)"
                [attr.title]="colorOption.name">
                <mat-icon *ngIf="selectedColor === colorOption.value">check</mat-icon>
              </div>
            </div>
          </div>
          
          <button type="submit" class="submit-btn" [disabled]="editGroupForm.invalid || isLoading">
            {{ isLoading ? 'Saving...' : 'Save Changes' }}
          </button>
        </form>
      </div>

      <!-- New Note Form -->
      <div *ngIf="showNewNoteForm" class="new-note-form-container" [@slideDown]>
        <form [formGroup]="newNoteForm" (ngSubmit)="createNote()" class="new-note-form">
          <div class="form-group">
            <label for="title">Title</label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="title" 
                formControlName="title" 
                class="form-control"
                [class.is-invalid]="title?.invalid && (title?.dirty || title?.touched)"
                [maxlength]="TITLE_MAX_LENGTH"
              >
            </div>
            <div class="feedback-container">
              <div class="feedback-left">
                <div *ngIf="title?.invalid && (title?.dirty || title?.touched)" class="error-message">
                  <span *ngIf="title?.errors?.['required']">Title is required</span>
                  <span *ngIf="title?.errors?.['maxlength']">Title cannot exceed 75 characters</span>
                </div>
              </div>
              <span class="character-counter" 
                    [class.warning]="titleLengthWarning"
                    [class.danger]="titleLengthDanger">
                {{ title?.value?.length || 0 }}/{{ TITLE_MAX_LENGTH }}
              </span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="subtitle">Subtitle</label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="subtitle" 
                formControlName="subtitle" 
                class="form-control"
                [class.is-invalid]="subtitle?.invalid && (subtitle?.dirty || subtitle?.touched)"
                [maxlength]="SUBTITLE_MAX_LENGTH"
              >
            </div>
            <div class="feedback-container">
              <div class="feedback-left">
                <div *ngIf="subtitle?.invalid && (subtitle?.dirty || subtitle?.touched)" class="error-message">
                  <span *ngIf="subtitle?.errors?.['required']">Subtitle is required</span>
                  <span *ngIf="subtitle?.errors?.['maxlength']">Subtitle cannot exceed 150 characters</span>
                </div>
              </div>
              <span class="character-counter" 
                    [class.warning]="subtitleLengthWarning"
                    [class.danger]="subtitleLengthDanger">
                {{ subtitle?.value?.length || 0 }}/{{ SUBTITLE_MAX_LENGTH }}
              </span>
            </div>
          </div>
          
          <!-- Color picker -->
          <div class="form-group color-picker-container">
            <label>Note Color:</label>
            <div class="color-options">
              <div 
                *ngFor="let colorOption of colorOptions" 
                class="color-option" 
                [style.background-color]="colorOption.value"
                [class.selected]="selectedColor === colorOption.value"
                [class.no-color]="colorOption.name === 'none'"
                (click)="setNoteColor(colorOption.value)"
                [attr.title]="colorOption.name">
                <mat-icon *ngIf="selectedColor === colorOption.value">check</mat-icon>
              </div>
            </div>
          </div>
          
          <button type="submit" class="submit-btn" [disabled]="newNoteForm.invalid || isLoading">
            {{ isLoading ? 'Creating...' : 'Create Note' }}
          </button>
        </form>
      </div>

      <!-- Loading Spinner for Notes -->
      <div *ngIf="!isLoadingGroup && isLoadingNotes" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading notes...</p>
      </div>

      <!-- Empty state with Add Note -->
      <div *ngIf="!isLoadingGroup && !isLoadingNotes && notes.length === 0" 
           class="empty-notes-container"
           [@fadeInOut]>
        <div class="empty-note-card"
            (click)="toggleNewNoteForm()">
          <div class="add-note-content">
            <mat-icon class="add-icon">note_add</mat-icon>
            <span class="add-text">New Note</span>
          </div>
        </div>
      </div>

      <!-- Notes Grid -->
      <div *ngIf="!isLoadingGroup && !isLoadingNotes && notes.length > 0" 
           class="notes-grid" 
           [@listAnimation]="notes.length">
        <div class="note-card add-note-card"
            (click)="toggleNewNoteForm()">
          <div class="add-note-content">
            <mat-icon class="add-icon">note_add</mat-icon>
            <span class="add-text">New Note</span>
          </div>
        </div>
        
        <!-- Existing Notes -->
        <div *ngFor="let note of notes; trackBy: trackNoteById" 
             class="note-card"
             [ngClass]="{'colored-note': note.color}"
             [style.backgroundColor]="note.color">
          <div class="note-card-content" [routerLink]="['/notes', note.id]">
            <div class="note-text-wrapper">
              <h2 class="note-title">{{ note.title }}</h2>
              <p class="note-subtitle">{{ note.subtitle }}</p>
            </div>
            <div *ngIf="showPreview" class="note-preview-container" [@previewExpand]>
              <pre class="note-preview" [class.empty]="!note.content">{{ note.content || "There's nothing here..." }}</pre>
            </div>
            <div class="note-footer">
              <span class="note-date">{{ note.updatedAt | date:'medium' }}</span>
            </div>
          </div>
          <div class="note-menu" (click)="stopPropagation($event)">
            <app-note-group-menu 
              [note]="note"
              (archive)="onArchive(note)"
              (trash)="onTrash(note)"
              (restore)="onRestore(note)"
              (delete)="onDelete(note)"
              (removeFromGroup)="removeNoteFromGroup(note)">
            </app-note-group-menu>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
